{% extends base_template %}

{% block title %}{{ book.title }} - Library Management System{% endblock %}

{% block content %}
<div class="container my-5">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm rounded-4">
        <div class="card-header bg-primary text-white rounded-top-4 d-flex align-items-center">
          <i class="fas fa-book fa-2x me-3"></i>
          <h2 class="mb-0">{{ book.title }}</h2>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-4 text-center mb-4 mb-md-0">
              <div class="text-center mb-3">
                {% if book.cover_image_url %}
                  <img src="{{ book.cover_image_url }}" alt="{{ book.title }} cover" class="img-fluid rounded-3" style="max-height: 180px; object-fit: contain;">
                {% else %}
                  <div class="book-cover-placeholder rounded-3 d-flex align-items-center justify-content-center bg-secondary text-white" style="height: 180px;">
                    <i class="fas fa-book-open fa-3x"></i>
                  </div>
                {% endif %}
              </div>
              <div class="mt-3">
                {% if book.availability_status %}
                  <span class="badge bg-success fs-6 px-3 py-2">
                    <i class="fas fa-check-circle me-1"></i>Available
                  </span>
                {% else %}
                  <span class="badge bg-danger fs-6 px-3 py-2">
                    <i class="fas fa-times-circle me-1"></i>Unavailable
                  </span>
                {% endif %}
              </div>
            </div>
            <div class="col-md-8">
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <strong>Author:</strong>
                  <span>{{ book.author }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <strong>ISBN:</strong>
                  <span>{{ book.isbn }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <strong>Category:</strong>
                  <span>{{ book.category|default:"Not specified" }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <strong>Available Quantity:</strong>
                  <span id="available-quantity">{{ book.available_quantity }}</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <strong>Published Date:</strong>
                  <span>{{ book.published_date|date:"M d, Y" }}</span>
                </li>
              </ul>
              {% if book.description %}
              <div class="mt-4">
                <h5>Description</h5>
                <p>{{ book.description }}</p>
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        <div class="card-footer d-flex flex-wrap justify-content-center gap-3">
          {% if not is_staff %}
          <button type="button" id="borrowBtn" class="btn btn-primary btn-lg px-4" data-book-id="{{ book.id }}">
            <i class="fas fa-hand-holding-usd me-2"></i>Borrow this Book
          </button>

          <a href="{% url 'return_book' %}" class="btn btn-outline-secondary btn-lg px-4">
            <i class="fas fa-undo me-2"></i>Return a Book
          </a>
          {% endif %}

          <a href="{% url 'book_list' %}" class="btn btn-outline-primary btn-lg px-4">
            <i class="fas fa-arrow-left me-2"></i>Back to Books
          </a>

          {% if is_staff %}
          <a href="{% url 'edit_book' book.id %}" class="btn btn-outline-warning btn-lg px-4">
            <i class="fas fa-edit me-2"></i>Edit Book
          </a>

          <a href="{% url 'delete_book' book.id %}" class="btn btn-outline-danger btn-lg px-4" onclick="return confirm('Are you sure you want to delete this book?');">
            <i class="fas fa-trash me-2"></i>Delete Book
          </a>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Notification Container -->
<div id="notification-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1050;">
</div>

<!-- Hidden form for fallback -->
<form id="borrowForm" method="POST" action="{% url 'borrow_book' book.id %}" style="display: none;">
  {% csrf_token %}
</form>

<style>
  body {
    background: #f5f7fa;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    color: #333;
  }
  .card {
    border: none;
  }
  .book-cover-placeholder {
    background: #6c757d;
  }
  .btn-lg {
    border-radius: 0.5rem;
    font-weight: 600;
  }
  .btn-primary {
    background: linear-gradient(135deg, #4a90e2 0%, #357ABD 100%);
    border: none;
  }
  .btn-primary:hover {
    background: linear-gradient(135deg, #357ABD 0%, #4a90e2 100%);
  }
  .btn-outline-secondary {
    border-radius: 0.5rem;
    border: 2px solid #6c757d;
    color: #6c757d;
  }
  .btn-outline-secondary:hover {
    background: #e9ecef;
    color: #495057;
  }
  .btn-outline-primary {
    border-radius: 0.5rem;
    border: 2px solid #357ABD;
    color: #357ABD;
  }
  .btn-outline-primary:hover {
    background: #357ABD;
    color: white;
  }
  .badge {
    font-size: 0.9rem;
    border-radius: 1rem;
    font-weight: 600;
  }
  h2, h5 {
    font-weight: 700;
  }

  /* Notification Styles */
  .notification {
    background: white;
    border: 1px solid #e1e5e9;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    padding: 1rem 1.5rem;
    margin-bottom: 0.5rem;
    min-width: 300px;
    animation: slideIn 0.3s ease-out;
  }

  .notification.success {
    border-left: 4px solid #28a745;
  }

  .notification.error {
    border-left: 4px solid #dc3545;
  }

  .notification.info {
    border-left: 4px solid #17a2b8;
  }

  .notification-icon {
    width: 20px;
    text-align: center;
    margin-right: 0.75rem;
  }

  .notification-content {
    flex: 1;
  }

  .notification-title {
    font-weight: 600;
    margin-bottom: 0.25rem;
  }

  .notification-message {
    font-size: 0.875rem;
    color: #6c757d;
    margin: 0;
  }

  .notification-close {
    background: none;
    border: none;
    color: #6c757d;
    cursor: pointer;
    padding: 0;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-left: 0.5rem;
  }

  .notification-close:hover {
    color: #495057;
  }

  @keyframes slideIn {
    from {
      transform: translateX(100%);
      opacity: 0;
    }
    to {
      transform: translateX(0);
      opacity: 1;
    }
  }

  .notification.fade-out {
    animation: fadeOut 0.3s ease-out forwards;
  }

  @keyframes fadeOut {
    from {
      transform: translateX(0);
      opacity: 1;
    }
    to {
      transform: translateX(100%);
      opacity: 0;
    }
  }

  /* Loading state for button */
  .btn-loading {
    position: relative;
    color: transparent !important;
  }

  .btn-loading::after {
    content: "";
    position: absolute;
    width: 16px;
    height: 16px;
    top: 50%;
    left: 50%;
    margin-left: -8px;
    margin-top: -8px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to {
      transform: rotate(360deg);
    }
  }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const borrowBtn = document.getElementById('borrowBtn');
  const borrowForm = document.getElementById('borrowForm');
  const notificationContainer = document.getElementById('notification-container');
  const availableQuantity = document.getElementById('available-quantity');

  if (borrowBtn) {
    borrowBtn.addEventListener('click', function() {
      const bookId = this.getAttribute('data-book-id');

      // Add loading state
      this.classList.add('btn-loading');
      this.disabled = true;

      // Prepare AJAX request
      const formData = new FormData();
      formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);

      fetch(`/transactions/borrow/${bookId}/`, {
        method: 'POST',
        body: formData,
        headers: {
          'X-Requested-With': 'XMLHttpRequest',
        },
      })
      .then(response => response.json())
      .then(data => {
        // Remove loading state
        borrowBtn.classList.remove('btn-loading');
        borrowBtn.disabled = false;

        if (data.success) {
          // Show success notification
          showNotification('success', 'Book Borrowed!', data.message);

          // Update available quantity if provided
          if (data.available_quantity !== undefined) {
            availableQuantity.textContent = data.available_quantity;
          }

          // Update availability badge
          updateAvailabilityBadge(data.availability_status);

          // Disable borrow button if no copies left
          if (data.available_quantity <= 0) {
            borrowBtn.disabled = true;
            borrowBtn.textContent = 'No Copies Available';
          }

        } else {
          // Show error notification
          showNotification('error', 'Borrow Failed', data.message);
        }
      })
      .catch(error => {
        // Remove loading state
        borrowBtn.classList.remove('btn-loading');
        borrowBtn.disabled = false;

        // Fallback to form submission
        borrowForm.submit();
      });
    });
  }

  function showNotification(type, title, message) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
      <div class="d-flex align-items-start">
        <div class="notification-icon">
          <i class="fas ${getIconForType(type)}"></i>
        </div>
        <div class="notification-content">
          <div class="notification-title">${title}</div>
          <p class="notification-message">${message}</p>
        </div>
        <button type="button" class="notification-close" onclick="this.parentElement.parentElement.remove()">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;

    notificationContainer.appendChild(notification);

    // Auto remove after 5 seconds
    setTimeout(() => {
      notification.classList.add('fade-out');
      setTimeout(() => {
        if (notification.parentElement) {
          notification.remove();
        }
      }, 300);
    }, 5000);
  }

  function getIconForType(type) {
    switch(type) {
      case 'success': return 'fa-check-circle';
      case 'error': return 'fa-exclamation-circle';
      case 'info': return 'fa-info-circle';
      default: return 'fa-info-circle';
    }
  }

  function updateAvailabilityBadge(isAvailable) {
    const badgeContainer = document.querySelector('.mt-3');
    const existingBadge = badgeContainer.querySelector('.badge');

    if (existingBadge) {
      existingBadge.remove();
    }

    const newBadge = document.createElement('span');
    newBadge.className = `badge fs-6 px-3 py-2 ${isAvailable ? 'bg-success' : 'bg-danger'}`;
    newBadge.innerHTML = `
      <i class="fas fa-${isAvailable ? 'check-circle' : 'times-circle'} me-1"></i>
      ${isAvailable ? 'Available' : 'Unavailable'}
    `;

    badgeContainer.appendChild(newBadge);
  }
});
</script>
{% endblock %}
